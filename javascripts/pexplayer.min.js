/*! PexPlayer - v0.1.0 - 2013-12-03
* Copyright (c) 2013 DeNA Co., Ltd.; Licensed MIT */
(function(t){function e(){this.init.apply(this,arguments)}function i(e){if(this.userConfig=e,"object"!=typeof e)throw"invalid config value:"+typeof e;this.isWebStorageEnabled()&&t.localStorage.setItem("pexUserConfig",JSON.stringify(e||{}))}function n(){return this.isWebStorageEnabled()?JSON.parse(t.localStorage.pexUserConfig||"{}"):{}}function a(){var t=this.internalConfig;return t.enableUserConfig?f(t,this.getUserConfig()):t}function o(e){if(e||!this.cap){var i=this.userAgent,n=this.config.cap;if(!n)if(i.isChrome)n="high";else if(i.isIOS){var a=t,o=460>Math.max(a.innerWidth,a.innerHeight);n=o&&"middle"||"high"}else n="low";this.cap=n}return this.cap}function s(){var e;try{t.sessionStorage.setItem("test",1),e=!0}catch(i){e=!1}return e}function r(e){var i={devicePerf:40,enableUserConfig:!0,handlername:"swfend"};if(e)for(var n in i)null==e[n]&&(e[n]=i[n]);else e=i;this.internalConfig=e,this.config=this.getMergedConfig();var a=t;this.devicePixelRatio=a.devicePixelRatio||1,h(this,a),this.listener={},t[e.handlername]=function(t){return function(){t.receive.apply(t,arguments)}}(this);var o;this.defaultOption={srcWidth:320,srcHeight:416,touchDetector:{},useCalibrator:!1,calibration:{name:null,byTime:!0,timeDuration:6200,step:.2,higherThrethold:85,lowerThrethold:60},option:{width:320,debug:o,suppressLog:{drawCache:!0,fps:!0},compileAction:!1,partialDraw:!0,shapeDetail:{all:{method:"cache",cacheScale:1}},transparent:!1}}}function h(t,e){var i=e.navigator.userAgent,n=i.match(/Android\s*(\d+)\.(\d+)\.?(\d*)/),a=i.match(/OS\s*(\d+)_(\d+)_?(\d?)/);i.search(/iPhone|iPod|iPad/)>=0;var o,s,r,h=i.match(/Chrome\/(\d+)\.(\d+)/);if(n)t.isApplePalmDevice=!1,t.isLegacyIOS=!1,s=[0|n[1],0|n[2],0|n[3]],h?(o="android"+n[1]+n[2]+"chrome"+h[1],r=[0|h[1],0|h[2]]):(o="android"+n[1]+n[2],t.isLegacyAndroid=!0);else if(a){var l=i.search(/iPhone|iPod/)>0;t.isApplePalmDevice=l,t.isLegacyIOS=7>a[1],o="ios"+a[1]+a[2],s=[0|a[1],0|a[2],0|a[3]]}else o="unknown",s=[0,0,0];t.userAgent={shortName:o,isChrome:!!h,isAndroid:!!n,isIOS:!!a,version:s,browserVersion:r}}function l(t,e){var i=this.listener[t];!i&&(i=[]),i[i.length]=e,this.listener[t]=i}function c(t){t=t.replace(/[^\w\:\_\/]/g,"");var e=this.listener[t];if(e){this.listener[t]=null;for(var i,n=0;i=e[n];n++)switch(typeof i){case"function":i.apply(this,arguments);break;case"object":i.pass("recieve "+t)}}else 0>t.indexOf("/:")&&this.receive("/:"+t)}function d(e,i,n){this.config,n=f(this.defaultOption,n||{});var a=t;n.fullscreen?(n.displayWidth=a.innerWidth,n.displayHeight=a.innerHeight):n.displayWidth||(n.displayWidth=n.srcWidth,n.displayHeight=n.srcHeight);var o=new p(this,e,i,n);return n.preventDestroy||a.addEventListener("beforeunload",o,!1),o}function f(t,e){var i={};for(var n in t)i[n]=t[n];if(e)for(var a in e){var o=e[a],s=i[a];i[a]=s&&"object"==typeof s?f(i[a],o):o}return i}var t,u=function(){function t(){this.init.apply(this,arguments)}function e(t,e){this.parentSwf=t,this.api=t.api,this.name=e}function i(t,e){this.api.setMovieClipProperty(this.name,t,e)}function n(){this.api.setVisible(this.name,1)}function a(){this.api.setVisible(this.name,0)}function o(t,e){this.api.setVariable(this.name,t,e)}function s(t){this.api.getVariable(this.name,t)}function r(t,e){e&&this.parentSwf.context.addListener(this.name+":"+t,e),this.api.gotoFrame(this.name,t)}function h(t,e){e&&this.parentSwf.context.addListener(this.name+":"+t,e),this.api.gotoAndStop(this.name,t)}return t.prototype={init:e,setVariable:o,getVariable:s,setProperty:i,gotoFrame:r,gotoAndPlay:r,gotoAndStop:h,show:n,hide:a},t}();e.prototype={init:r,getCap:o,isWebStorageEnabled:s,addListener:l,setUserConfig:i,getUserConfig:n,getMergedConfig:a,receive:c,play:d},e.helper={mergeOptions:f};var p=function(t){function i(t){this.context=t,this.isStarted=!1}function n(){var t=this.context.api._getStatics();this.basement={renderCount:t.renderCount,_frameCount:t._frameCount},this.isStarted=!0}function a(){if(!this.isStarted)throw"call swf.scorer.start() at first";var t=this.basement,e=this.context.api._getStatics(),i=e.renderCount-t.renderCount,n=e._frameCount-t._frameCount,a=(i/n).toFixed(2);return["rate",a,"rendered",i,"planned",n]}function o(){this.init.apply(this,arguments)}function s(t){"beforeunload"===t.type&&this.destroy()}function r(){var t,e=this.context.getCap(),t=(this.option.option||{}).cacheMaxTotalSize;if(e){var i;switch(e){case"low":i=15728640;break;case"middle":i=83886080;break;case"high":i=157286400;break;default:throw"invalid cap-value:"+e}t>i&&(t=i)}return t}function h(){this.api&&this.api.destroy(),this.context=null,this.canvas=null,this.mcs=null,this.api=null,this.swf=null,delete this.context,delete this.canvas,delete this.mcs,delete this.api,delete this.swf}function l(n,a,o,s){this.context=n,this.storageKey="pex"+(s.calibration.name||a),this.canvas=o,this.option=s,this.useCalibrator="low"!==n.getCap()&&s.useCalibrator,this.logicalMaxRatio=this.getLogicalMaxRatio(),this.renderingRatio=this.getRenderingRatio(),this.scorer=new i(this),this.statics={_frameCount:0,renderCount:0};var r=t;s.fullscreen,this.orientation=0===r.orientation?"portrait":"landscape",this.offsets={portrait:null,landscape:null},this.mcs={};var h={width:~~(s.srcWidth*this.renderingRatio),cacheMaxTotalSize:this.defineCacheMaxTotalSize()},l=e.helper.mergeOptions(s.option,h),c=new Pex(a,o,l),d=c.getAPI();this.pex=c,this.api=d;var f=this,u=s.ready;u&&d.ready(function(){u(f,d)});var p=s.calibration;this.useCalibrator&&p.byTime&&d.ready(function(){setTimeout(function(){f.calibrate()},p.timeDuration)});var g,v,m,y=s.onload||{},b=!(y.zoom===!1);n.isApplePalmDevice&&n.isLegacyIOS&&(g=!(y.scrollTo===!1),v=s.forceScrollUp,m=!0),r.addEventListener("orientationchange",function(){setTimeout(function(){m&&this.scrollTo(0,0),f.orientation=0===r.orientation/90%2?"portrait":"landscape",f.adjustZoom()},n.isLegacyAndroid?280:10)},!1);var C=r.document.readyState;"complete"==C||"interactive"==C||"loaded"==C?(g&&r.scrollTo(0,0),b&&this.adjustZoom()):r.addEventListener("DOMContentLoaded",function(){setTimeout(function(){g&&r.scrollTo(0,0),b&&f.adjustZoom()},30)},!1),v&&function x(){setTimeout(function(){r.scrollTo(0,0),x()},800)}()}function c(){this.statics=this.api._getStatics()}function d(){if(!this.useCalibrator||this.isCalibrated||!this.context.isWebStorageEnabled())return null;var e=this.statics,i=this.option.calibration,n=this.renderingRatio,a=this.api._getStatics(),o=a.renderCount-e.renderCount,s=a._frameCount-e._frameCount,r=100*(o/s),h=this.logicalMaxRatio;r>i.higherThrethold&&h>n?(n+=i.step,n>h&&(n=h)):i.lowerThrethold>r&&(n-=i.step,1>n&&(n=1));var l=t.localStorage;return l.setItem(this.storageKey+"_stats",["rate:rendered:pland",r,o,s].join(",")),l.setItem(this.storageKey,n.toFixed(1)),this.isCalibrated=!0,n}function f(){var e,i,n=this.option;if(n.useCalibrator&&(e=parseFloat(t.localStorage.getItem(this.storageKey))),!e){var a=this.context.config.devicePerf;i=a>50?this.logicalMaxRatio:a>23?Math.min(2,this.logicalMaxRatio):a>12?1.5:1}return e?e:i}function p(){var t,e=this.context,i=this.option;t=i.displayWidth>i.displayHeight?i.displayHeight/i.srcHeight:i.displayWidth/i.srcWidth;var n=t*e.devicePixelRatio;return n}function g(t){return this.mcs[t]||(this.mcs[t]=new u(this,t)),this.mcs[t]}function v(e,i){var n=this.offsets[this.orientation],a=this.zoom/100,o=this.renderingRatio,s=t;if(!n){var r=this.canvas;n=[r.offsetLeft*a,r.offsetTop*a];var h=this.option.touchDetector.container,l=h?s.document.querySelector(h):null;l&&(n[0]+=l.offsetLeft,n[1]+=l.offsetTop),this.offsets[this.orientation]=n}var c=(e-n[0]+s.scrollX)/a/o,d=(i-n[1]+s.scrollY)/a/o;return[c,d]}function m(t,e,i){var n=this.getLocalCoordinate(e,i),a=n[0],o=n[1],s=[];for(var r in t){var h=t[r];h[0]+h[2]>a&&a>h[0]&&h[1]+h[3]>o&&o>h[1]&&(s[s.length]=r)}return s}function y(e,i,n){!n&&(n="#ff3a37");var a=this.canvas,o=a.width,s=a.height,r=this.zoom,h=this.renderingRatio;e.width=o,e.height=s;var l=e.style;l.zoom=r+"%";var c=a.offsetTop,d=a.offsetLeft;if(this.option.fullscreen){l.position="absolute";var f=r/100;c=(t.innerHeight-s*f)/2/f,d=(t.innerWidth-o*f)/2/f,l.top=c+"px",l.left=d+"px"}var u=e.getContext("2d");u.strokeStyle=n;for(var p in i){for(var g=i[p],v=[],m=0;g.length>m;m++)v[m]=g[m]*h;u.rect.apply(u,v)}u.stroke();var y=this;e.addEventListener("click",function(t){console.log("local coordinate",y.getLocalCoordinate(t.clientX,t.clientY)),console.log("detect",y.detectLabelFromPosition(i,t.clientX,t.clientY))},!1)}function b(){var e,i,n=t,a=this.option,o=a.fullscreen;o?(e=n.innerWidth,i=n.innerHeight):(e=a.displayWidth,i=a.displayHeight);var s=this.logicalMaxRatio,r=this.renderingRatio,h=100*Math.min(i/a.srcHeight/r||s,e/a.srcWidth/r||s);if(100===h&&(h=100.1),o){var l=~~(.75*100*(1/r));h=Math.max(h,l)}h=h.toFixed(1),this.zoom=h,this.canvas.style.zoom=h+"%"}return i.prototype={start:n,get:a},o.prototype={init:l,destroy:h,calibrate:d,setCalibrationBasement:c,startCalibration:c,getLogicalMaxRatio:p,getRenderingRatio:f,adjustZoom:b,detectLabelFromPosition:m,getLocalCoordinate:v,drawLabelMap:y,getMovieClip:g,handleEvent:s,defineCacheMaxTotalSize:r},o}(this.self||t);t.PexPlayer||(t.PexPlayer=e)})(this.self||global);